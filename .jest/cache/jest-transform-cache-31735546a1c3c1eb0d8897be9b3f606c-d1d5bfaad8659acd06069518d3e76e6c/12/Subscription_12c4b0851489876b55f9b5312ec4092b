d4025b4d3913e7c9706c3e3297144b21
"use strict";

exports.__esModule = true;
exports.createSubscription = createSubscription;

var _batch = require("./batch");

function createListenerCollection() {
  var batch = (0, _batch.getBatch)();
  var first = null;
  var last = null;
  return {
    clear: function clear() {
      first = null;
      last = null;
    },
    notify: function notify() {
      batch(function () {
        var listener = first;

        while (listener) {
          listener.callback();
          listener = listener.next;
        }
      });
    },
    get: function get() {
      var listeners = [];
      var listener = first;

      while (listener) {
        listeners.push(listener);
        listener = listener.next;
      }

      return listeners;
    },
    subscribe: function subscribe(callback) {
      var isSubscribed = true;
      var listener = last = {
        callback: callback,
        next: null,
        prev: last
      };

      if (listener.prev) {
        listener.prev.next = listener;
      } else {
        first = listener;
      }

      return function unsubscribe() {
        if (!isSubscribed || first === null) return;
        isSubscribed = false;

        if (listener.next) {
          listener.next.prev = listener.prev;
        } else {
          last = listener.prev;
        }

        if (listener.prev) {
          listener.prev.next = listener.next;
        } else {
          first = listener.next;
        }
      };
    }
  };
}

var nullListeners = {
  notify: function notify() {},
  get: function get() {
    return [];
  }
};

function createSubscription(store, parentSub) {
  var unsubscribe;
  var listeners = nullListeners;

  function addNestedSub(listener) {
    trySubscribe();
    return listeners.subscribe(listener);
  }

  function notifyNestedSubs() {
    listeners.notify();
  }

  function handleChangeWrapper() {
    if (subscription.onStateChange) {
      subscription.onStateChange();
    }
  }

  function isSubscribed() {
    return Boolean(unsubscribe);
  }

  function trySubscribe() {
    if (!unsubscribe) {
      unsubscribe = parentSub ? parentSub.addNestedSub(handleChangeWrapper) : store.subscribe(handleChangeWrapper);
      listeners = createListenerCollection();
    }
  }

  function tryUnsubscribe() {
    if (unsubscribe) {
      unsubscribe();
      unsubscribe = undefined;
      listeners.clear();
      listeners = nullListeners;
    }
  }

  var subscription = {
    addNestedSub: addNestedSub,
    notifyNestedSubs: notifyNestedSubs,
    handleChangeWrapper: handleChangeWrapper,
    isSubscribed: isSubscribed,
    trySubscribe: trySubscribe,
    tryUnsubscribe: tryUnsubscribe,
    getListeners: function getListeners() {
      return listeners;
    }
  };
  return subscription;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlN1YnNjcmlwdGlvbi5qcyJdLCJuYW1lcyI6WyJleHBvcnRzIiwiX19lc01vZHVsZSIsImNyZWF0ZVN1YnNjcmlwdGlvbiIsIl9iYXRjaCIsInJlcXVpcmUiLCJjcmVhdGVMaXN0ZW5lckNvbGxlY3Rpb24iLCJiYXRjaCIsImdldEJhdGNoIiwiZmlyc3QiLCJsYXN0IiwiY2xlYXIiLCJub3RpZnkiLCJsaXN0ZW5lciIsImNhbGxiYWNrIiwibmV4dCIsImdldCIsImxpc3RlbmVycyIsInB1c2giLCJzdWJzY3JpYmUiLCJpc1N1YnNjcmliZWQiLCJwcmV2IiwidW5zdWJzY3JpYmUiLCJudWxsTGlzdGVuZXJzIiwic3RvcmUiLCJwYXJlbnRTdWIiLCJhZGROZXN0ZWRTdWIiLCJ0cnlTdWJzY3JpYmUiLCJub3RpZnlOZXN0ZWRTdWJzIiwiaGFuZGxlQ2hhbmdlV3JhcHBlciIsInN1YnNjcmlwdGlvbiIsIm9uU3RhdGVDaGFuZ2UiLCJCb29sZWFuIiwidHJ5VW5zdWJzY3JpYmUiLCJ1bmRlZmluZWQiLCJnZXRMaXN0ZW5lcnMiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBQSxPQUFPLENBQUNDLFVBQVIsR0FBcUIsSUFBckI7QUFDQUQsT0FBTyxDQUFDRSxrQkFBUixHQUE2QkEsa0JBQTdCOztBQUVBLElBQUlDLE1BQU0sR0FBR0MsT0FBTyxXQUFwQjs7QUFLQSxTQUFTQyx3QkFBVCxHQUFvQztBQUNsQyxNQUFJQyxLQUFLLEdBQUcsQ0FBQyxHQUFHSCxNQUFNLENBQUNJLFFBQVgsR0FBWjtBQUNBLE1BQUlDLEtBQUssR0FBRyxJQUFaO0FBQ0EsTUFBSUMsSUFBSSxHQUFHLElBQVg7QUFDQSxTQUFPO0FBQ0xDLElBQUFBLEtBQUssRUFBRSxTQUFTQSxLQUFULEdBQWlCO0FBQ3RCRixNQUFBQSxLQUFLLEdBQUcsSUFBUjtBQUNBQyxNQUFBQSxJQUFJLEdBQUcsSUFBUDtBQUNELEtBSkk7QUFLTEUsSUFBQUEsTUFBTSxFQUFFLFNBQVNBLE1BQVQsR0FBa0I7QUFDeEJM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TCxFQUFrQjtBQUNoQkEsTUFBQUEsV0FBVyxHQUFHRyxTQUFTLEdBQUdBLFNBQVMsQ0FBQ0MsWUFBVixDQUF1QkcsbUJBQXZCLENBQUgsR0FBaURMLEtBQUssQ0FBQ0wsU0FBTixDQUFnQlUsbUJBQWhCLENBQXhFO0FBQ0FaLE1BQUFBLFNBQVMsR0FBR1gsd0JBQXdCLEVBQXBDO0FBQ0Q7QUFDRjs7QUFFRCxXQUFTMkIsY0FBVCxHQUEwQjtBQUN4QixRQUFJWCxXQUFKLEVBQWlCO0FBQ2ZBLE1BQUFBLFdBQVc7QUFDWEEsTUFBQUEsV0FBVyxHQUFHWSxTQUFkO0FBQ0FqQixNQUFBQSxTQUFTLENBQUNOLEtBQVY7QUFDQU0sTUFBQUEsU0FBUyxHQUFHTSxhQUFaO0FBQ0Q7QUFDRjs7QUFFRCxNQUFJTyxZQUFZLEdBQUc7QUFDakJKLElBQUFBLFlBQVksRUFBRUEsWUFERztBQUVqQkUsSUFBQUEsZ0JBQWdCLEVBQUVBLGdCQUZEO0FBR2pCQyxJQUFBQSxtQkFBbUIsRUFBRUEsbUJBSEo7QUFJakJULElBQUFBLFlBQVksRUFBRUEsWUFKRztBQUtqQk8sSUFBQUEsWUFBWSxFQUFFQSxZQUxHO0FBTWpCTSxJQUFBQSxjQUFjLEVBQUVBLGNBTkM7QUFPakJFLElBQUFBLFlBQVksRUFBRSxTQUFTQSxZQUFULEdBQXdCO0FBQ3BDLGFBQU9sQixTQUFQO0FBQ0Q7QUFUZ0IsR0FBbkI7QUFXQSxTQUFPYSxZQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuZXhwb3J0cy5fX2VzTW9kdWxlID0gdHJ1ZTtcbmV4cG9ydHMuY3JlYXRlU3Vic2NyaXB0aW9uID0gY3JlYXRlU3Vic2NyaXB0aW9uO1xuXG52YXIgX2JhdGNoID0gcmVxdWlyZShcIi4vYmF0Y2hcIik7XG5cbi8vIGVuY2Fwc3VsYXRlcyB0aGUgc3Vic2NyaXB0aW9uIGxvZ2ljIGZvciBjb25uZWN0aW5nIGEgY29tcG9uZW50IHRvIHRoZSByZWR1eCBzdG9yZSwgYXNcbi8vIHdlbGwgYXMgbmVzdGluZyBzdWJzY3JpcHRpb25zIG9mIGRlc2NlbmRhbnQgY29tcG9uZW50cywgc28gdGhhdCB3ZSBjYW4gZW5zdXJlIHRoZVxuLy8gYW5jZXN0b3IgY29tcG9uZW50cyByZS1yZW5kZXIgYmVmb3JlIGRlc2NlbmRhbnRzXG5mdW5jdGlvbiBjcmVhdGVMaXN0ZW5lckNvbGxlY3Rpb24oKSB7XG4gIHZhciBiYXRjaCA9ICgwLCBfYmF0Y2guZ2V0QmF0Y2gpKCk7XG4gIHZhciBmaXJzdCA9IG51bGw7XG4gIHZhciBsYXN0ID0gbnVsbDtcbiAgcmV0dXJuIHtcbiAgICBjbGVhcjogZnVuY3Rpb24gY2xlYXIoKSB7XG4gICAgICBmaXJzdCA9IG51bGw7XG4gICAgICBsYXN0ID0gbnVsbDtcbiAgICB9LFxuICAgIG5vdGlmeTogZnVuY3Rpb24gbm90aWZ5KCkge1xuICAgICAgYmF0Y2goZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgbGlzdGVuZXIgPSBmaXJzdDtcblxuICAgICAgICB3aGlsZSAobGlzdGVuZXIpIHtcbiAgICAgICAgICBsaXN0ZW5lci5jYWxsYmFjaygpO1xuICAgICAgICAgIGxpc3RlbmVyID0gbGlzdGVuZXIubmV4dDtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSxcbiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHtcbiAgICAgIHZhciBsaXN0ZW5lcnMgPSBbXTtcbiAgICAgIHZhciBsaXN0ZW5lciA9IGZpcnN0O1xuXG4gICAgICB3aGlsZSAobGlzdGVuZXIpIHtcbiAgICAgICAgbGlzdGVuZXJzLnB1c2gobGlzdGVuZXIpO1xuICAgICAgICBsaXN0ZW5lciA9IGxpc3RlbmVyLm5leHQ7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBsaXN0ZW5lcnM7XG4gICAgfSxcbiAgICBzdWJzY3JpYmU6IGZ1bmN0aW9uIHN1YnNjcmliZShjYWxsYmFjaykge1xuICAgICAgdmFyIGlzU3Vic2NyaWJlZCA9IHRydWU7XG4gICAgICB2YXIgbGlzdGVuZXIgPSBsYXN0ID0ge1xuICAgICAgICBjYWxsYmFjazogY2FsbGJhY2ssXG4gICAgICAgIG5leHQ6IG51bGwsXG4gICAgICAgIHByZXY6IGxhc3RcbiAgICAgIH07XG5cbiAgICAgIGlmIChsaXN0ZW5lci5wcmV2KSB7XG4gICAgICAgIGxpc3RlbmVyLnByZXYubmV4dCA9IGxpc3RlbmVyO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZmlyc3QgPSBsaXN0ZW5lcjtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGZ1bmN0aW9uIHVuc3Vic2NyaWJlKCkge1xuICAgICAgICBpZiAoIWlzU3Vic2NyaWJlZCB8fCBmaXJzdCA9PT0gbnVsbCkgcmV0dXJuO1xuICAgICAgICBpc1N1YnNjcmliZWQgPSBmYWxzZTtcblxuICAgICAgICBpZiAobGlzdGVuZXIubmV4dCkge1xuICAgICAgICAgIGxpc3RlbmVyLm5leHQucHJldiA9IGxpc3RlbmVyLnByZXY7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbGFzdCA9IGxpc3RlbmVyLnByZXY7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobGlzdGVuZXIucHJldikge1xuICAgICAgICAgIGxpc3RlbmVyLnByZXYubmV4dCA9IGxpc3RlbmVyLm5leHQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZmlyc3QgPSBsaXN0ZW5lci5uZXh0O1xuICAgICAgICB9XG4gICAgICB9O1xuICAgIH1cbiAgfTtcbn1cblxudmFyIG51bGxMaXN0ZW5lcnMgPSB7XG4gIG5vdGlmeTogZnVuY3Rpb24gbm90aWZ5KCkge30sXG4gIGdldDogZnVuY3Rpb24gZ2V0KCkge1xuICAgIHJldHVybiBbXTtcbiAgfVxufTtcblxuZnVuY3Rpb24gY3JlYXRlU3Vic2NyaXB0aW9uKHN0b3JlLCBwYXJlbnRTdWIpIHtcbiAgdmFyIHVuc3Vic2NyaWJlO1xuICB2YXIgbGlzdGVuZXJzID0gbnVsbExpc3RlbmVycztcblxuICBmdW5jdGlvbiBhZGROZXN0ZWRTdWIobGlzdGVuZXIpIHtcbiAgICB0cnlTdWJzY3JpYmUoKTtcbiAgICByZXR1cm4gbGlzdGVuZXJzLnN1YnNjcmliZShsaXN0ZW5lcik7XG4gIH1cblxuICBmdW5jdGlvbiBub3RpZnlOZXN0ZWRTdWJzKCkge1xuICAgIGxpc3RlbmVycy5ub3RpZnkoKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGhhbmRsZUNoYW5nZVdyYXBwZXIoKSB7XG4gICAgaWYgKHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlKSB7XG4gICAgICBzdWJzY3JpcHRpb24ub25TdGF0ZUNoYW5nZSgpO1xuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIGlzU3Vic2NyaWJlZCgpIHtcbiAgICByZXR1cm4gQm9vbGVhbih1bnN1YnNjcmliZSk7XG4gIH1cblxuICBmdW5jdGlvbiB0cnlTdWJzY3JpYmUoKSB7XG4gICAgaWYgKCF1bnN1YnNjcmliZSkge1xuICAgICAgdW5zdWJzY3JpYmUgPSBwYXJlbnRTdWIgPyBwYXJlbnRTdWIuYWRkTmVzdGVkU3ViKGhhbmRsZUNoYW5nZVdyYXBwZXIpIDogc3RvcmUuc3Vic2NyaWJlKGhhbmRsZUNoYW5nZVdyYXBwZXIpO1xuICAgICAgbGlzdGVuZXJzID0gY3JlYXRlTGlzdGVuZXJDb2xsZWN0aW9uKCk7XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gdHJ5VW5zdWJzY3JpYmUoKSB7XG4gICAgaWYgKHVuc3Vic2NyaWJlKSB7XG4gICAgICB1bnN1YnNjcmliZSgpO1xuICAgICAgdW5zdWJzY3JpYmUgPSB1bmRlZmluZWQ7XG4gICAgICBsaXN0ZW5lcnMuY2xlYXIoKTtcbiAgICAgIGxpc3RlbmVycyA9IG51bGxMaXN0ZW5lcnM7XG4gICAgfVxuICB9XG5cbiAgdmFyIHN1YnNjcmlwdGlvbiA9IHtcbiAgICBhZGROZXN0ZWRTdWI6IGFkZE5lc3RlZFN1YixcbiAgICBub3RpZnlOZXN0ZWRTdWJzOiBub3RpZnlOZXN0ZWRTdWJzLFxuICAgIGhhbmRsZUNoYW5nZVdyYXBwZXI6IGhhbmRsZUNoYW5nZVdyYXBwZXIsXG4gICAgaXNTdWJzY3JpYmVkOiBpc1N1YnNjcmliZWQsXG4gICAgdHJ5U3Vic2NyaWJlOiB0cnlTdWJzY3JpYmUsXG4gICAgdHJ5VW5zdWJzY3JpYmU6IHRyeVVuc3Vic2NyaWJlLFxuICAgIGdldExpc3RlbmVyczogZnVuY3Rpb24gZ2V0TGlzdGVuZXJzKCkge1xuICAgICAgcmV0dXJuIGxpc3RlbmVycztcbiAgICB9XG4gIH07XG4gIHJldHVybiBzdWJzY3JpcHRpb247XG59Il19