8d12758d2b1701c93d571781a0bb25bc
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault")["default"];

exports.__esModule = true;
exports["default"] = finalPropsSelectorFactory;
exports.impureFinalPropsSelectorFactory = impureFinalPropsSelectorFactory;
exports.pureFinalPropsSelectorFactory = pureFinalPropsSelectorFactory;

var _objectWithoutPropertiesLoose2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutPropertiesLoose"));

var _verifySubselectors = _interopRequireDefault(require("./verifySubselectors"));

var _excluded = ["initMapStateToProps", "initMapDispatchToProps", "initMergeProps"];

function impureFinalPropsSelectorFactory(mapStateToProps, mapDispatchToProps, mergeProps, dispatch) {
  return function impureFinalPropsSelector(state, ownProps) {
    return mergeProps(mapStateToProps(state, ownProps), mapDispatchToProps(dispatch, ownProps), ownProps);
  };
}

function pureFinalPropsSelectorFactory(mapStateToProps, mapDispatchToProps, mergeProps, dispatch, _ref) {
  var areStatesEqual = _ref.areStatesEqual,
      areOwnPropsEqual = _ref.areOwnPropsEqual,
      areStatePropsEqual = _ref.areStatePropsEqual;
  var hasRunAtLeastOnce = false;
  var state;
  var ownProps;
  var stateProps;
  var dispatchProps;
  var mergedProps;

  function handleFirstCall(firstState, firstOwnProps) {
    state = firstState;
    ownProps = firstOwnProps;
    stateProps = mapStateToProps(state, ownProps);
    dispatchProps = mapDispatchToProps(dispatch, ownProps);
    mergedProps = mergeProps(stateProps, dispatchProps, ownProps);
    hasRunAtLeastOnce = true;
    return mergedProps;
  }

  function handleNewPropsAndNewState() {
    stateProps = mapStateToProps(state, ownProps);
    if (mapDispatchToProps.dependsOnOwnProps) dispatchProps = mapDispatchToProps(dispatch, ownProps);
    mergedProps = mergeProps(stateProps, dispatchProps, ownProps);
    return mergedProps;
  }

  function handleNewProps() {
    if (mapStateToProps.dependsOnOwnProps) stateProps = mapStateToProps(state, ownProps);
    if (mapDispatchToProps.dependsOnOwnProps) dispatchProps = mapDispatchToProps(dispatch, ownProps);
    mergedProps = mergeProps(stateProps, dispatchProps, ownProps);
    return mergedProps;
  }

  function handleNewState() {
    var nextStateProps = mapStateToProps(state, ownProps);
    var statePropsChanged = !areStatePropsEqual(nextStateProps, stateProps);
    stateProps = nextStateProps;
    if (statePropsChanged) mergedProps = mergeProps(stateProps, dispatchProps, ownProps);
    return mergedProps;
  }

  function handleSubsequentCalls(nextState, nextOwnProps) {
    var propsChanged = !areOwnPropsEqual(nextOwnProps, ownProps);
    var stateChanged = !areStatesEqual(nextState, state);
    state = nextState;
    ownProps = nextOwnProps;
    if (propsChanged && stateChanged) return handleNewPropsAndNewState();
    if (propsChanged) return handleNewProps();
    if (stateChanged) return handleNewState();
    return mergedProps;
  }

  return function pureFinalPropsSelector(nextState, nextOwnProps) {
    return hasRunAtLeastOnce ? handleSubsequentCalls(nextState, nextOwnProps) : handleFirstCall(nextState, nextOwnProps);
  };
}

function finalPropsSelectorFactory(dispatch, _ref2) {
  var initMapStateToProps = _ref2.initMapStateToProps,
      initMapDispatchToProps = _ref2.initMapDispatchToProps,
      initMergeProps = _ref2.initMergeProps,
      options = (0, _objectWithoutPropertiesLoose2["default"])(_ref2, _excluded);
  var mapStateToProps = initMapStateToProps(dispatch, options);
  var mapDispatchToProps = initMapDispatchToProps(dispatch, options);
  var mergeProps = initMergeProps(dispatch, options);

  if (process.env.NODE_ENV !== 'production') {
    (0, _verifySubselectors["default"])(mapStateToProps, mapDispatchToProps, mergeProps, options.displayName);
  }

  var selectorFactory = options.pure ? pureFinalPropsSelectorFactory : impureFinalPropsSelectorFactory;
  return selectorFactory(mapStateToProps, mapDispatchToProps, mergeProps, dispatch, options);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlbGVjdG9yRmFjdG9yeS5qcyJdLCJuYW1lcyI6WyJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsImV4cG9ydHMiLCJfX2VzTW9kdWxlIiwiZmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeSIsImltcHVyZUZpbmFsUHJvcHNTZWxlY3RvckZhY3RvcnkiLCJwdXJlRmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeSIsIl9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMiIsIl92ZXJpZnlTdWJzZWxlY3RvcnMiLCJfZXhjbHVkZWQiLCJtYXBTdGF0ZVRvUHJvcHMiLCJtYXBEaXNwYXRjaFRvUHJvcHMiLCJtZXJnZVByb3BzIiwiZGlzcGF0Y2giLCJpbXB1cmVGaW5hbFByb3BzU2VsZWN0b3IiLCJzdGF0ZSIsIm93blByb3BzIiwiX3JlZiIsImFyZVN0YXRlc0VxdWFsIiwiYXJlT3duUHJvcHNFcXVhbCIsImFyZVN0YXRlUHJvcHNFcXVhbCIsImhhc1J1bkF0TGVhc3RPbmNlIiwic3RhdGVQcm9wcyIsImRpc3BhdGNoUHJvcHMiLCJtZXJnZWRQcm9wcyIsImhhbmRsZUZpcnN0Q2FsbCIsImZpcnN0U3RhdGUiLCJmaXJzdE93blByb3BzIiwiaGFuZGxlTmV3UHJvcHNBbmROZXdTdGF0ZSIsImRlcGVuZHNPbk93blByb3BzIiwiaGFuZGxlTmV3UHJvcHMiLCJoYW5kbGVOZXdTdGF0ZSIsIm5leHRTdGF0ZVByb3BzIiwic3RhdGVQcm9wc0NoYW5nZWQiLCJoYW5kbGVTdWJzZXF1ZW50Q2FsbHMiLCJuZXh0U3RhdGUiLCJuZXh0T3duUHJvcHMiLCJwcm9wc0NoYW5nZWQiLCJzdGF0ZUNoYW5nZWQiLCJwdXJlRmluYWxQcm9wc1NlbGVjdG9yIiwiX3JlZjIiLCJpbml0TWFwU3RhdGVUb1Byb3BzIiwiaW5pdE1hcERpc3BhdGNoVG9Qcm9wcyIsImluaXRNZXJnZVByb3BzIiwib3B0aW9ucyIsInByb2Nlc3MiLCJlbnYiLCJOT0RFX0VOViIsImRpc3BsYXlOYW1lIiwic2VsZWN0b3JGYWN0b3J5IiwicHVyZSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBSUEsc0JBQXNCLEdBQUdDLE9BQU8sQ0FBQyw4Q0FBRCxDQUFQLENBQXdELFNBQXhELENBQTdCOztBQUVBQyxPQUFPLENBQUNDLFVBQVIsR0FBcUIsSUFBckI7QUFDQUQsT0FBTyxDQUFDLFNBQUQsQ0FBUCxHQUFxQkUseUJBQXJCO0FBQ0FGLE9BQU8sQ0FBQ0csK0JBQVIsR0FBMENBLCtCQUExQztBQUNBSCxPQUFPLENBQUNJLDZCQUFSLEdBQXdDQSw2QkFBeEM7O0FBRUEsSUFBSUMsOEJBQThCLEdBQUdQLHNCQUFzQixDQUFDQyxPQUFPLENBQUMscURBQUQsQ0FBUixDQUEzRDs7QUFFQSxJQUFJTyxtQkFBbUIsR0FBR1Isc0JBQXNCLENBQUNDLE9BQU8sd0JBQVIsQ0FBaEQ7O0FBRUEsSUFBSVEsU0FBUyxHQUFHLENBQUMscUJBQUQsRUFBd0Isd0JBQXhCLEVBQWtELGdCQUFsRCxDQUFoQjs7QUFFQSxTQUFTSiwrQkFBVCxDQUF5Q0ssZUFBekMsRUFBMERDLGtCQUExRCxFQUE4RUMsVUFBOUUsRUFBMEZDLFFBQTFGLEVBQW9HO0FBQ2xHLFNBQU8sU0FBU0Msd0JBQVQsQ0FBa0NDLEtBQWxDLEVBQXlDQyxRQUF6QyxFQUFtRDtBQUN4RCxXQUFPSixVQUFVLENBQUNGLGVBQWUsQ0FBQ0ssS0FBRCxFQUFRQyxRQUFSLENBQWhCLEVBQW1DTCxrQkFBa0IsQ0FBQ0UsUUFBRCxFQUFXRyxRQUFYLENBQXJELEVBQTJFQSxRQUEzRSxDQUFqQjtBQUNELEdBRkQ7QUFHRDs7QUFFRCxTQUFTViw2QkFBVCxDQUF1Q0ksZUFBdkMsRUFBd0RDLGtCQUF4RCxFQUE0RUMsVUFBNUUsRUFBd0ZDLFFBQXhGLEVBQWtHSSxJQUFsRyxFQUF3RztBQUN0RyxNQUFJQyxjQUFjLEdBQUdELElBQUksQ0FBQ0MsY0FBMUI7QUFBQSxNQUNJQyxnQkFBZ0IsR0FBR0YsSUFBSSxDQUFDRSxnQkFENUI7QUFBQSxNQUVJQyxrQkFBa0IsR0FBR0gsSUFBSSxDQUFDRyxrQkFGOUI7QUFHQSxNQUFJQyxpQkFBaUIsR0FBRyxLQUF4QjtBQUNBLE1BQUlOLEtBQUo7QUFDQSxNQUFJQyxRQUFKO0FBQ0EsTUFBSU0sVUFBSjtBQUNBLE1BQUlDLGFBQUo7QUFDQSxNQUFJQyxXQUFKOztBQUVBLFdBQVNDLGVBQVQsQ0FBeUJDLFVBQXpCLEVBQXFDQyxhQUFyQyxFQUFvRDtBQUNsRFosSUFBQUEsS0FBSyxHQUFHVyxVQUFSO0FBQ0FWLElBQUFBLFFBQVEsR0FBR1csYUFBWDtBQUNBTCxJQUFBQSxVQUFVLEdBQUdaLGVBQWUsQ0FBQ0ssS0FBRCxFQUFRQyxRQUFSLENBQTVCO0FBQ0FPLElBQUFBLGFBQWEsR0FBR1osa0JBQWtCLENBQUNFLFFBQUQsRUFBV0csUUFBWCxDQUFsQztBQUNBUSxJQUFBQSxXQUFXLEdBQUdaLFVBQVUsQ0FBQ1UsVUFBRCxFQUFhQyxhQUFiLEVBQTRCUCxRQUE1QixDQUF4QjtBQUNBSyxJQUFBQSxpQkFBaUIsR0FBRyxJQUFwQjtBQUNBLFdBQU9HLFdBQVA7QUFDRDs7QUFFRCxXQUFTSSx5QkFBVCxHQUFxQztBQUNuQ04sSUFBQUEsVUFBVSxHQUFHWixlQUFlLENBQUNLLEtBQUQsRUFBUUMsUUFBUixDQUE1QjtBQUNBLFFBQUlMLGtCQUFrQixDQUFDa0IsaUJBQXZCLEVBQTBDTixhQUFhLEdBQUdaLGtCQUFrQixDQUFDRSxRQUFELEVBQVdHLFFBQVgsQ0FBbEM7QUFDMUNRLElBQUFBLFdBQVcsR0FBR1osVUFBVSxDQUFDVSxVQUFELEVBQWFDLGFBQWIsRUFBNEJQLFFBQTVCLENBQXhCO0FBQ0EsV0FBT1EsV0FBUDtBQUNEOztBQUVELFdBQVNNLGNBQVQsR0FBMEI7QUFDeEIsUUFBSXBCLGVBQWUsQ0FBQ21CLGlCQUFwQixFQUF1Q1AsVUFBVSxHQUFHWixlQUFlLENBQUNLLEtBQUQsRUFBUUMsUUFBUixDQUE1QjtBQUN2QyxRQUFJTCxrQkFBa0IsQ0FBQ2tCLGlCQUF2QixFQUEwQ04sYUFBYSxHQUFHWixrQkFBa0IsQ0FBQ0UsUUFBRCxFQUFXRyxRQUFYLENBQWxDO0FBQzFDUSxJQUFBQSxXQUFXLEdBQUdaLFVBQVUsQ0FBQ1UsVUFBRCxFQUFhQyxhQUFiLEVBQTRCUCxRQUE1QixDQUF4QjtBQUNBLFdBQU9RLFdBQVA7QUFDRDs7QUFFRCxXQUFTTyxjQUFULEdBQTBCO0FBQ3hCLFFBQUlDLGNBQWMsR0FBR3RCLGVBQWUsQ0FBQ0ssS0FBRCxFQUFRQyxRQUFSLENBQXBDO0FBQ0EsUUFBSWlCLGlCQUFpQixHQUFHLENBQUNiLGtCQUFrQixDQUFDWSxjQUFELEVBQWlCVixVQUFqQixDQUEzQztBQUNBQSxJQUFBQSxVQUFVLEdBQUdVLGNBQWI7QUFDQSxRQUFJQyxpQkFBSixFQUF1QlQsV0FBVyxHQUFHWixVQUFVLENBQUNVLFVBQUQsRUFBYUMsYUFBYixFQUE0QlAsUUFBNUIsQ0FBeEI7QUFDdkIsV0FBT1EsV0FBUDtBQUNEOztBQUVELFdBQVNVLHFCQUFULENBQStCQyxTQUEvQixFQUEwQ0MsWUFBMUMsRUFBd0Q7QUFDdEQsUUFBSUMsWUFBWSxHQUFHLENBQUNsQixnQkFBZ0IsQ0FBQ2lCLFlBQUQsRUFBZXBCLFFBQWYsQ0FBcEM7QUFDQSxRQUFJc0IsWUFBWSxHQUFHLENBQUNwQixjQUFjLENBQUNpQixTQUFELEVBQVlwQixLQUFaLENBQWxDO0FBQ0FBLElBQUFBLEtBQUssR0FBR29CLFNBQVI7QUFDQW5CLElBQUFBLFFBQVEsR0FBR29CLFlBQVg7QUFDQSxRQUFJQyxZQUFZLElBQUlDLFlBQXBCLEVBQWtDLE9BQU9WLHlCQUF5QixFQUFoQztBQUNsQyxRQUFJUyxZQUFKLEVBQWtCLE9BQU9QLGNBQWMsRUFBckI7QUFDbEIsUUFBSVEsWUFBSixFQUFrQixPQUFPUCxjQUFjLEVBQXJCO0FBQ2xCLFdBQU9QLFdBQVA7QUFDRDs7QUFFRCxTQUFPLFNBQVNlLHNCQUFULENBQWdDSixTQUFoQyxFQUEyQ0MsWUFBM0MsRUFBeUQ7QUFDOUQsV0FBT2YsaUJBQWlCLEdBQUdhLHFCQUFxQixDQUFDQyxTQUFELEVBQVlDLFlBQVosQ0FBeEIsR0FBb0RYLGVBQWUsQ0FBQ1UsU0FBRCxFQUFZQyxZQUFaLENBQTNGO0FBQ0QsR0FGRDtBQUdEOztBQU9ELFNBQVNoQyx5QkFBVCxDQUFtQ1MsUUFBbkMsRUFBNkMyQixLQUE3QyxFQUFvRDtBQUNsRCxNQUFJQyxtQkFBbUIsR0FBR0QsS0FBSyxDQUFDQyxtQkFBaEM7QUFBQSxNQUNJQyxzQkFBc0IsR0FBR0YsS0FBSyxDQUFDRSxzQkFEbkM7QUFBQSxNQUVJQyxjQUFjLEdBQUdILEtBQUssQ0FBQ0csY0FGM0I7QUFBQSxNQUdJQyxPQUFPLEdBQUcsQ0FBQyxHQUFHckMsOEJBQThCLENBQUMsU0FBRCxDQUFsQyxFQUErQ2lDLEtBQS9DLEVBQXNEL0IsU0FBdEQsQ0FIZDtBQUlBLE1BQUlDLGVBQWUsR0FBRytCLG1CQUFtQixDQUFDNUIsUUFBRCxFQUFXK0IsT0FBWCxDQUF6QztBQUNBLE1BQUlqQyxrQkFBa0IsR0FBRytCLHNCQUFzQixDQUFDN0IsUUFBRCxFQUFXK0IsT0FBWCxDQUEvQztBQUNBLE1BQUloQyxVQUFVLEdBQUcrQixjQUFjLENBQUM5QixRQUFELEVBQVcrQixPQUFYLENBQS9COztBQUVBLE1BQUlDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxRQUFaLEtBQXlCLFlBQTdCLEVBQTJDO0FBQ3pDLEtBQUMsR0FBR3ZDLG1CQUFtQixDQUFDLFNBQUQsQ0FBdkIsRUFBb0NFLGVBQXBDLEVBQXFEQyxrQkFBckQsRUFBeUVDLFVBQXpFLEVBQXFGZ0MsT0FBTyxDQUFDSSxXQUE3RjtBQUNEOztBQUVELE1BQUlDLGVBQWUsR0FBR0wsT0FBTyxDQUFDTSxJQUFSLEdBQWU1Qyw2QkFBZixHQUErQ0QsK0JBQXJFO0FBQ0EsU0FBTzRDLGVBQWUsQ0FBQ3ZDLGVBQUQsRUFBa0JDLGtCQUFsQixFQUFzQ0MsVUFBdEMsRUFBa0RDLFFBQWxELEVBQTREK0IsT0FBNUQsQ0FBdEI7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG52YXIgX2ludGVyb3BSZXF1aXJlRGVmYXVsdCA9IHJlcXVpcmUoXCJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2ludGVyb3BSZXF1aXJlRGVmYXVsdFwiKVtcImRlZmF1bHRcIl07XG5cbmV4cG9ydHMuX19lc01vZHVsZSA9IHRydWU7XG5leHBvcnRzW1wiZGVmYXVsdFwiXSA9IGZpbmFsUHJvcHNTZWxlY3RvckZhY3Rvcnk7XG5leHBvcnRzLmltcHVyZUZpbmFsUHJvcHNTZWxlY3RvckZhY3RvcnkgPSBpbXB1cmVGaW5hbFByb3BzU2VsZWN0b3JGYWN0b3J5O1xuZXhwb3J0cy5wdXJlRmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeSA9IHB1cmVGaW5hbFByb3BzU2VsZWN0b3JGYWN0b3J5O1xuXG52YXIgX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlXCIpKTtcblxudmFyIF92ZXJpZnlTdWJzZWxlY3RvcnMgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCIuL3ZlcmlmeVN1YnNlbGVjdG9yc1wiKSk7XG5cbnZhciBfZXhjbHVkZWQgPSBbXCJpbml0TWFwU3RhdGVUb1Byb3BzXCIsIFwiaW5pdE1hcERpc3BhdGNoVG9Qcm9wc1wiLCBcImluaXRNZXJnZVByb3BzXCJdO1xuXG5mdW5jdGlvbiBpbXB1cmVGaW5hbFByb3BzU2VsZWN0b3JGYWN0b3J5KG1hcFN0YXRlVG9Qcm9wcywgbWFwRGlzcGF0Y2hUb1Byb3BzLCBtZXJnZVByb3BzLCBkaXNwYXRjaCkge1xuICByZXR1cm4gZnVuY3Rpb24gaW1wdXJlRmluYWxQcm9wc1NlbGVjdG9yKHN0YXRlLCBvd25Qcm9wcykge1xuICAgIHJldHVybiBtZXJnZVByb3BzKG1hcFN0YXRlVG9Qcm9wcyhzdGF0ZSwgb3duUHJvcHMpLCBtYXBEaXNwYXRjaFRvUHJvcHMoZGlzcGF0Y2gsIG93blByb3BzKSwgb3duUHJvcHMpO1xuICB9O1xufVxuXG5mdW5jdGlvbiBwdXJlRmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeShtYXBTdGF0ZVRvUHJvcHMsIG1hcERpc3BhdGNoVG9Qcm9wcywgbWVyZ2VQcm9wcywgZGlzcGF0Y2gsIF9yZWYpIHtcbiAgdmFyIGFyZVN0YXRlc0VxdWFsID0gX3JlZi5hcmVTdGF0ZXNFcXVhbCxcbiAgICAgIGFyZU93blByb3BzRXF1YWwgPSBfcmVmLmFyZU93blByb3BzRXF1YWwsXG4gICAgICBhcmVTdGF0ZVByb3BzRXF1YWwgPSBfcmVmLmFyZVN0YXRlUHJvcHNFcXVhbDtcbiAgdmFyIGhhc1J1bkF0TGVhc3RPbmNlID0gZmFsc2U7XG4gIHZhciBzdGF0ZTtcbiAgdmFyIG93blByb3BzO1xuICB2YXIgc3RhdGVQcm9wcztcbiAgdmFyIGRpc3BhdGNoUHJvcHM7XG4gIHZhciBtZXJnZWRQcm9wcztcblxuICBmdW5jdGlvbiBoYW5kbGVGaXJzdENhbGwoZmlyc3RTdGF0ZSwgZmlyc3RPd25Qcm9wcykge1xuICAgIHN0YXRlID0gZmlyc3RTdGF0ZTtcbiAgICBvd25Qcm9wcyA9IGZpcnN0T3duUHJvcHM7XG4gICAgc3RhdGVQcm9wcyA9IG1hcFN0YXRlVG9Qcm9wcyhzdGF0ZSwgb3duUHJvcHMpO1xuICAgIGRpc3BhdGNoUHJvcHMgPSBtYXBEaXNwYXRjaFRvUHJvcHMoZGlzcGF0Y2gsIG93blByb3BzKTtcbiAgICBtZXJnZWRQcm9wcyA9IG1lcmdlUHJvcHMoc3RhdGVQcm9wcywgZGlzcGF0Y2hQcm9wcywgb3duUHJvcHMpO1xuICAgIGhhc1J1bkF0TGVhc3RPbmNlID0gdHJ1ZTtcbiAgICByZXR1cm4gbWVyZ2VkUHJvcHM7XG4gIH1cblxuICBmdW5jdGlvbiBoYW5kbGVOZXdQcm9wc0FuZE5ld1N0YXRlKCkge1xuICAgIHN0YXRlUHJvcHMgPSBtYXBTdGF0ZVRvUHJvcHMoc3RhdGUsIG93blByb3BzKTtcbiAgICBpZiAobWFwRGlzcGF0Y2hUb1Byb3BzLmRlcGVuZHNPbk93blByb3BzKSBkaXNwYXRjaFByb3BzID0gbWFwRGlzcGF0Y2hUb1Byb3BzKGRpc3BhdGNoLCBvd25Qcm9wcyk7XG4gICAgbWVyZ2VkUHJvcHMgPSBtZXJnZVByb3BzKHN0YXRlUHJvcHMsIGRpc3BhdGNoUHJvcHMsIG93blByb3BzKTtcbiAgICByZXR1cm4gbWVyZ2VkUHJvcHM7XG4gIH1cblxuICBmdW5jdGlvbiBoYW5kbGVOZXdQcm9wcygpIHtcbiAgICBpZiAobWFwU3RhdGVUb1Byb3BzLmRlcGVuZHNPbk93blByb3BzKSBzdGF0ZVByb3BzID0gbWFwU3RhdGVUb1Byb3BzKHN0YXRlLCBvd25Qcm9wcyk7XG4gICAgaWYgKG1hcERpc3BhdGNoVG9Qcm9wcy5kZXBlbmRzT25Pd25Qcm9wcykgZGlzcGF0Y2hQcm9wcyA9IG1hcERpc3BhdGNoVG9Qcm9wcyhkaXNwYXRjaCwgb3duUHJvcHMpO1xuICAgIG1lcmdlZFByb3BzID0gbWVyZ2VQcm9wcyhzdGF0ZVByb3BzLCBkaXNwYXRjaFByb3BzLCBvd25Qcm9wcyk7XG4gICAgcmV0dXJuIG1lcmdlZFByb3BzO1xuICB9XG5cbiAgZnVuY3Rpb24gaGFuZGxlTmV3U3RhdGUoKSB7XG4gICAgdmFyIG5leHRTdGF0ZVByb3BzID0gbWFwU3RhdGVUb1Byb3BzKHN0YXRlLCBvd25Qcm9wcyk7XG4gICAgdmFyIHN0YXRlUHJvcHNDaGFuZ2VkID0gIWFyZVN0YXRlUHJvcHNFcXVhbChuZXh0U3RhdGVQcm9wcywgc3RhdGVQcm9wcyk7XG4gICAgc3RhdGVQcm9wcyA9IG5leHRTdGF0ZVByb3BzO1xuICAgIGlmIChzdGF0ZVByb3BzQ2hhbmdlZCkgbWVyZ2VkUHJvcHMgPSBtZXJnZVByb3BzKHN0YXRlUHJvcHMsIGRpc3BhdGNoUHJvcHMsIG93blByb3BzKTtcbiAgICByZXR1cm4gbWVyZ2VkUHJvcHM7XG4gIH1cblxuICBmdW5jdGlvbiBoYW5kbGVTdWJzZXF1ZW50Q2FsbHMobmV4dFN0YXRlLCBuZXh0T3duUHJvcHMpIHtcbiAgICB2YXIgcHJvcHNDaGFuZ2VkID0gIWFyZU93blByb3BzRXF1YWwobmV4dE93blByb3BzLCBvd25Qcm9wcyk7XG4gICAgdmFyIHN0YXRlQ2hhbmdlZCA9ICFhcmVTdGF0ZXNFcXVhbChuZXh0U3RhdGUsIHN0YXRlKTtcbiAgICBzdGF0ZSA9IG5leHRTdGF0ZTtcbiAgICBvd25Qcm9wcyA9IG5leHRPd25Qcm9wcztcbiAgICBpZiAocHJvcHNDaGFuZ2VkICYmIHN0YXRlQ2hhbmdlZCkgcmV0dXJuIGhhbmRsZU5ld1Byb3BzQW5kTmV3U3RhdGUoKTtcbiAgICBpZiAocHJvcHNDaGFuZ2VkKSByZXR1cm4gaGFuZGxlTmV3UHJvcHMoKTtcbiAgICBpZiAoc3RhdGVDaGFuZ2VkKSByZXR1cm4gaGFuZGxlTmV3U3RhdGUoKTtcbiAgICByZXR1cm4gbWVyZ2VkUHJvcHM7XG4gIH1cblxuICByZXR1cm4gZnVuY3Rpb24gcHVyZUZpbmFsUHJvcHNTZWxlY3RvcihuZXh0U3RhdGUsIG5leHRPd25Qcm9wcykge1xuICAgIHJldHVybiBoYXNSdW5BdExlYXN0T25jZSA/IGhhbmRsZVN1YnNlcXVlbnRDYWxscyhuZXh0U3RhdGUsIG5leHRPd25Qcm9wcykgOiBoYW5kbGVGaXJzdENhbGwobmV4dFN0YXRlLCBuZXh0T3duUHJvcHMpO1xuICB9O1xufSAvLyBUT0RPOiBBZGQgbW9yZSBjb21tZW50c1xuLy8gSWYgcHVyZSBpcyB0cnVlLCB0aGUgc2VsZWN0b3IgcmV0dXJuZWQgYnkgc2VsZWN0b3JGYWN0b3J5IHdpbGwgbWVtb2l6ZSBpdHMgcmVzdWx0cyxcbi8vIGFsbG93aW5nIGNvbm5lY3RBZHZhbmNlZCdzIHNob3VsZENvbXBvbmVudFVwZGF0ZSB0byByZXR1cm4gZmFsc2UgaWYgZmluYWxcbi8vIHByb3BzIGhhdmUgbm90IGNoYW5nZWQuIElmIGZhbHNlLCB0aGUgc2VsZWN0b3Igd2lsbCBhbHdheXMgcmV0dXJuIGEgbmV3XG4vLyBvYmplY3QgYW5kIHNob3VsZENvbXBvbmVudFVwZGF0ZSB3aWxsIGFsd2F5cyByZXR1cm4gdHJ1ZS5cblxuXG5mdW5jdGlvbiBmaW5hbFByb3BzU2VsZWN0b3JGYWN0b3J5KGRpc3BhdGNoLCBfcmVmMikge1xuICB2YXIgaW5pdE1hcFN0YXRlVG9Qcm9wcyA9IF9yZWYyLmluaXRNYXBTdGF0ZVRvUHJvcHMsXG4gICAgICBpbml0TWFwRGlzcGF0Y2hUb1Byb3BzID0gX3JlZjIuaW5pdE1hcERpc3BhdGNoVG9Qcm9wcyxcbiAgICAgIGluaXRNZXJnZVByb3BzID0gX3JlZjIuaW5pdE1lcmdlUHJvcHMsXG4gICAgICBvcHRpb25zID0gKDAsIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMltcImRlZmF1bHRcIl0pKF9yZWYyLCBfZXhjbHVkZWQpO1xuICB2YXIgbWFwU3RhdGVUb1Byb3BzID0gaW5pdE1hcFN0YXRlVG9Qcm9wcyhkaXNwYXRjaCwgb3B0aW9ucyk7XG4gIHZhciBtYXBEaXNwYXRjaFRvUHJvcHMgPSBpbml0TWFwRGlzcGF0Y2hUb1Byb3BzKGRpc3BhdGNoLCBvcHRpb25zKTtcbiAgdmFyIG1lcmdlUHJvcHMgPSBpbml0TWVyZ2VQcm9wcyhkaXNwYXRjaCwgb3B0aW9ucyk7XG5cbiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHtcbiAgICAoMCwgX3ZlcmlmeVN1YnNlbGVjdG9yc1tcImRlZmF1bHRcIl0pKG1hcFN0YXRlVG9Qcm9wcywgbWFwRGlzcGF0Y2hUb1Byb3BzLCBtZXJnZVByb3BzLCBvcHRpb25zLmRpc3BsYXlOYW1lKTtcbiAgfVxuXG4gIHZhciBzZWxlY3RvckZhY3RvcnkgPSBvcHRpb25zLnB1cmUgPyBwdXJlRmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeSA6IGltcHVyZUZpbmFsUHJvcHNTZWxlY3RvckZhY3Rvcnk7XG4gIHJldHVybiBzZWxlY3RvckZhY3RvcnkobWFwU3RhdGVUb1Byb3BzLCBtYXBEaXNwYXRjaFRvUHJvcHMsIG1lcmdlUHJvcHMsIGRpc3BhdGNoLCBvcHRpb25zKTtcbn0iXX0=